# .github/workflows/daily-pr.yml
name: Daily PR from develop to main

on:
  schedule:
    - cron: "0 6 * * *" # 8 AM Amsterdam (summer, CEST)
    - cron: "0 7 * * *" # 8 AM Amsterdam (winter, CET)
  workflow_dispatch: # allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch remote branches
        run: |
          git fetch origin main
          git fetch origin develop

      - name: Check for new commits
        id: check_commits
        run: |
          if git log --oneline origin/main..origin/develop | grep .; then
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            echo "no_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Exit if no new commits
        if: steps.check_commits.outputs.no_changes == 'true'
        run: |
          echo "No new commits from develop to main. Exiting."
          exit 0

      - name: Create or update PR develop -> main
        if: steps.check_commits.outputs.no_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.PR_CREATE_TOKEN }}
        run: |
          echo "Generating commit summary for PR body..."

          # Ensure the branch exists on remote
          git push origin develop
          
          # Commit list with clickable links and author
          git log --no-merges --pretty=format:'- [%h](https://github.com/${GITHUB_REPOSITORY}/commit/%H) %s (%an)' origin/main..origin/develop


          COMPARE_URL="https://github.com/${GITHUB_REPOSITORY}/compare/main...develop"
          PR_DATE=$(date -u +"%Y-%m-%d")
          PR_TITLE="Daily Sync: develop → main (${PR_DATE})"

          # Build PR body
          BODY_FILE=$(mktemp)
          {
            echo "This is an automated daily PR from \`develop\` to \`main\`."
            echo
            echo "✅ Please review changes before merging."
            echo
            echo "### Compare"
            echo "${COMPARE_URL}"
            echo
            echo "### Changes included"
            if [ -n "$COMMIT_LIST" ]; then
              echo "$COMMIT_LIST"
            else
              echo "- No new commits (branches are in sync)."
            fi
          } > "$BODY_FILE"

          # Check if a PR already exists
          if gh pr list --base main --head develop --state open --json number --jq 'length' | grep -q '^0$'; then
            gh pr create \
              --base main \
              --head develop \
              --title "${PR_TITLE}" \
              --body-file "$BODY_FILE" \
              --label automated \
              --label daily-sync
          else
            echo "An open PR from develop to main already exists. Skipping creation."
          fi
